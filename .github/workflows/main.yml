name: Unit Test
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        build: [linux-release, windows-release, osx-release]
        include:
          - build: linux-release
            os: ubuntu-latest
            config: release
          - build: osx-release
            os: macos-14 # Binaries are built for macOS 15, need matching runner
            config: release            
          - build: windows-release
            os: windows-2022
            config: release
    steps:
    - name: Free Disk Space (Ubuntu)
      if: ${{ matrix.os == 'ubuntu-latest' }}
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        dotnet: false
  
    - uses: actions/checkout@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
    - name: Install Mobile Workloads
      if: ${{ contains(runner.os, 'windows') }}
      run: |
        dotnet workload install android --ignore-failed-sources
        dotnet workload install maui --ignore-failed-sources
    - name: Remove Mobile Project
      if: ${{ !contains(runner.os, 'windows') }}
      run: |
        dotnet sln LLamaSharp.sln remove Llama.Mobile
    - name: Cache Packages
      uses: actions/cache@v4
      with:
        key: "unit_test_models"
        path: LLama.Unittest/Models
    #  workaround for actions/setup-dotnet#155
    - name: Clear package cache
      run: dotnet clean LLamaSharp.sln && dotnet nuget locals all --clear
    - name: Restore packages
      run: dotnet restore LLamaSharp.sln
    - name: Build
      run: dotnet build LLamaSharp.sln -c ${{ matrix.config }} --no-restore
    - name: Fix macOS dylib rpaths
      if: ${{ matrix.os == 'macos-14' }}
      run: |
        # The dylibs are built with @rpath pointing to the build machine's directory.
        # We need to add @loader_path to the rpath so dependencies are found in the same directory.
        echo "Fixing rpaths for osx-arm64 dylibs..."
        for dylib in LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/*.dylib; do
          echo "Adding @loader_path rpath to: $dylib"
          install_name_tool -add_rpath @loader_path "$dylib" 2>/dev/null || true
        done
        echo "Fixing rpaths for osx-x64 dylibs..."
        for dylib in LLama.Unittest/bin/Release/net8.0/runtimes/osx-x64/native/*.dylib; do
          echo "Adding @loader_path rpath to: $dylib"
          install_name_tool -add_rpath @loader_path "$dylib" 2>/dev/null || true
        done
        for dylib in LLama.Unittest/bin/Release/net8.0/runtimes/osx-x64/native/rosetta2/*.dylib; do
          echo "Adding @loader_path rpath to: $dylib"
          install_name_tool -add_rpath @loader_path "$dylib" 2>/dev/null || true
        done
        echo "Done fixing rpaths"
    - name: Debug - List extracted deps (macOS)
      if: ${{ matrix.os == 'macos-14' }}
      run: |
        echo "=== Contents of LLama/runtimes/deps/osx-arm64/ ==="
        ls -la LLama/runtimes/deps/osx-arm64/ 2>/dev/null || echo "osx-arm64 folder not found"
        echo ""
        echo "=== Test output osx-arm64 native folder ==="
        ls -la LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/ 2>/dev/null || echo "folder not found"
        echo ""
        echo "=== Check libllama.dylib dependencies (otool -L) ==="
        otool -L LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/libllama.dylib 2>/dev/null || echo "otool failed"
        echo ""
        echo "=== Check libggml-metal.dylib dependencies ==="
        otool -L LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/libggml-metal.dylib 2>/dev/null || echo "otool failed"
        echo ""
        echo "=== Check file architecture ==="
        file LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/*.dylib 2>/dev/null || echo "file command failed"
        echo ""
        echo "=== Check code signature ==="
        codesign -vv LLama.Unittest/bin/Release/net8.0/runtimes/osx-arm64/native/libllama.dylib 2>&1 || echo "codesign check done"
        echo ""
        echo "=== Try loading library with dlopen (verbose) ==="
        cd LLama.Unittest/bin/Release/net8.0
        DYLD_PRINT_LIBRARIES=1 python3 -c "import ctypes; ctypes.CDLL('runtimes/osx-arm64/native/libllama.dylib')" 2>&1 || echo "dlopen test completed"
        cd -
    - name: Test
      run: dotnet test LLamaSharp.sln -c ${{ matrix.config }} -l "console;verbosity=detailed" --diag:logs/log.txt --filter Category!=NoCI
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        path: logs/
        name: logs-${{ matrix.os }}
